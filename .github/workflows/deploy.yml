# VelvetBot Auto-Deployment Workflow
# Triggers on push to main branch and deploys to your hosting service

name: Deploy VelvetBot

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # TEST JOB - Validate code before deployment
  # ============================================
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest

      - name: Lint with flake8
        run: |
          # Stop build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Warnings as errors, but allow some flexibility
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Check imports
        run: |
          python -c "from velvetbot.bot import VelvetBot; print('Imports OK')"

  # ============================================
  # DEPLOY JOB - Deploy to hosting service
  # ============================================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: test  # Only deploy if tests pass
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ==========================================
      # OPTION 1: Deploy via SSH (VPS/Dedicated)
      # Uncomment if using SSH deployment
      # ==========================================
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     port: ${{ secrets.SSH_PORT }}
      #     script: |
      #       cd /path/to/velvetbot
      #       git pull origin main
      #       pip install -r requirements.txt
      #       sudo systemctl restart velvetbot

      # ==========================================
      # OPTION 2: Deploy via Webhook (Wispbyte/PebbleHost/etc)
      # Uncomment if your host supports webhook deployment
      # ==========================================
      # - name: Trigger Deployment Webhook
      #   run: |
      #     curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}" \
      #       -H "Content-Type: application/json" \
      #       -d '{"ref": "main", "repository": "velvetbot"}'

      # ==========================================
      # OPTION 3: Deploy to Railway
      # Uncomment if using Railway
      # ==========================================
      # - name: Deploy to Railway
      #   uses: bervProject/railway-deploy@main
      #   with:
      #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
      #     service: velvetbot

      # ==========================================
      # OPTION 4: Deploy to Render
      # Uncomment if using Render
      # ==========================================
      # - name: Deploy to Render
      #   run: |
      #     curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"

      # ==========================================
      # NOTIFICATION - Discord webhook on deploy
      # ==========================================
      - name: Notify Discord on Deploy
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{"embeds": [{"title": "\u2705 VelvetBot Deployed", "description": "Successfully deployed from commit `'"${{ github.sha }}"'`", "color": 9166137, "footer": {"text": "GitHub Actions"}, "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}]}' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" || true

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Success" >> $GITHUB_STEP_SUMMARY
